<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title># Go - Sockets: The Genesis of Golang Connections — Golang net pkg #1 - @martinomburajr</title>
        

        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_1.html" class="active"><strong aria-hidden="true">1.</strong> Go - Sockets: The Genesis of Golang Connections — Golang net pkg #1</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">@martinomburajr</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="net_package_internals_banner.jpeg" alt="" /></p>
<h1><a class="header" href="#sockets-the-genesis-of-golang-connections--golang-net-pkg-1" id="sockets-the-genesis-of-golang-connections--golang-net-pkg-1">Sockets: The Genesis of Golang Connections — Golang net pkg #1</a></h1>
<p>Welcome to the first in a new series that attempts to breakdown the internals of
the Golang net package. The net package is filled with several networking
primitives that pair closely with the underlying OS to allow us to build world
class production networking applications. Renowned projects like Docker,
Kubernetes, CoreDNS, Traefik are architected in Go and are known for their
prowess in ability to quickly and efficiently shuffle packets to and from
various client server services.</p>
<p>In this article we shall perform a deep dive into the operating system (GOOS)
and look at Sockets and how they work, and start to piece together a model to
understand connections and networking. For the sake of demonstration, we shall
assume we are using a Unix based APIs.</p>
<h2><a class="header" href="#sockets" id="sockets">Sockets</a></h2>
<p>Sockets are a pretty old concept first widely introduced in 1983 in the 4.2BSD
implementation which then overflowed to pretty much every UNIX and other system.
Sockets are fundamentally a method of inter-process communication (IPC) that
extend to networked systems. Where other forms of IPC such as pipes and message
queues are limited to the machine itself, sockets can be opened and connections
from external sources can attach themselves to an available socket. To really
understand their role, we look at some of the typical methods used to call the
socket API, and observe a connection flow from one host to another.</p>
<h2><a class="header" href="#the-socket-api" id="the-socket-api">The Socket API</a></h2>
<p>There are about 5 core methods within the Socket API that applications that want
to network must call. These are <code>socket()</code>, <code>bind()</code>, <code>connect()</code>, <code>listen()</code> and
<code>accept()</code>. In this article we will look at <code>socket()</code> and <code>bind()</code></p>
<h3><a class="header" href="#1-socket" id="1-socket">1. Socket</a></h3>
<p>According to the <a href="https://man7.org/linux/man-pages/man2/socket.2.html">Linux man
pages</a>,</p>
<pre><code>The socket() call creates an endpoint for communication and returns a file descriptor that refers to that endpoint.
</code></pre>
<p>The creation of a socket is mostly performed by the kernel, so Go applications
must call this through the use of a syscall implemented in the syscall library.
Let’s examine the Go code where this syscall happens.</p>
<pre><code class="language-c">/**
* Code Snippet 1: Implementations of Socket syscall:
  Note the signatures shown for Unix and Windows are similar
  despite being on different GOOS.
*/

// Unix implementation of socket() system call
int socket(int domain, int type, int protocol);

// Windows implementation of socket() system call
SOCKET WSAAPI socket(int af, int type, int protocol);
</code></pre>
<p>Let’s take a look at each of the arguments.</p>
<p><code>domain:</code> The domain refers to the protocol family to be used in the
communication. this is sometimes referred to as the address family. Examples of
domains are:</p>
<p><img src="./socket_address_family.png" alt="Table 1: A list of Address Families supported by Windows. See more here" />
<strong>Table 1:</strong> A list of Address Families supported by Windows. See more here</p>
<p>Unix kernels also have <code>AF_UNIX</code> that performs communication within the kernel
on the same machine <em>(not used for external networking)</em>.</p>
<p><code>type:</code> The type represents the type of underlying transport to use. Represented
as either <code>SOCK_STREAM</code> for reliable, sequenced, connection oriented messages
(think TCP) as well as <code>SOCK_DGRAM</code> for connection-less, unreliable messages
(think UDP or UNIX connections).</p>
<p><code>protocol:</code> Protocol refers to a single protocol that supports the selected
socket. These are usually in a given protocol family and often this value is
defaulted to 0.</p>
<h3><a class="header" href="#2-bind" id="2-bind">2. Bind</a></h3>
<p>The next Important syscall is to the bind() method. After a socket is created
using the socket syscall() the socket exists without any address attached to it.
bind() locates the socket through the use of the file descriptor returned from
the socket creation, and attaches a network address to it.</p>
<pre><code class="language-c">/**
* Code Snippet 2: Implementations of bind() syscall: Note the similar function signatures.
*/

// Unix implementation of bind() system call
int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);

// Windows implementation of bind() system call
int WSAAPI bind(
  SOCKET         s,
  const sockaddr *name,
  int            namelen
);
</code></pre>
<p>Bind takes in the following arguments:</p>
<p><code>sockfd:</code> This represents the file descriptor of the socket returned after creation. Remember in the socket method, the return type is a file descriptor. In order to bind the socket we created, we use the file descriptor as the first argument to the bind method.</p>
<p><code>socketaddr:</code> Is a pointer to a struct that contains the address that the socket we created can be bound. The address must be “well-known” i.e fixed and resolved before binding. The address should not change after binding, otherwise a new socket will need to be created. DNS resolution should happen first, and we will look at this in an upcoming article.</p>
<p><code>socklen:</code> Refers to the size of the address struct</p>
<p>Bind is important as it provides a well-known path to and from the socket. It
also enables to kernel to broadcasts the whereabouts of the socket so external
systems can know where to connect. It is possible to omit a call to bind after
creating a socket, in which case the kernel will select a random available port
on localhost and bind to it. You may have noticed this when using
<code>httptest.NewServer()</code> method that does not give the option of specifying an
address, and lets the kernel handle it. Similarly when using a debugger in an
IDE e.g. Goland, when the debugger is run, the kernel chooses a port for the
debugger by either omitting a call to bind therefore returning a different port
each time. Once the debugger is stopped, the socket is destroyed.</p>
<h2><a class="header" href="#gos-implementation-of-socket-and-bind" id="gos-implementation-of-socket-and-bind">Go’s Implementation of Socket and Bind</a></h2>
<p>It’s time to shift our focus back to Go. We have seen the purpose of the
socket() and bind calls(), but the question remains, where and how are they
implemented.</p>
<pre><code class="language-c">/**
* Code Snippet 2: Implementations of bind() syscall: Note the similar function signatures.
*/


// This unimplemnted function is found in the syscall/syscall_linx_386.go file and is referenced by the socket function below.
// It is implemented in the syscall/asm_linux_s390x.s file
func rawsocketcall(call int, a0, a1, a2, a3, a4, a5 uintptr) (n int, err Errno)

// The bind method mirrors the Unix API for bind calls. A call to rawsocketcall is made (see methods above)
func bind(s int, addr unsafe.Pointer, addrlen _Socklen) (err error) {
	_, e := socketcall(_BIND, uintptr(s), uintptr(addr), uintptr(addrlen), 0, 0, 0)
	if e != 0 {
		err = e
	}
	return
}

// The socket method mirrors the Unix API for Socket calls. A call to rawsocketcall is made (see method above and below)
func socket(domain int, typ int, proto int) (fd int, err error) {
	fd, e := rawsocketcall(_SOCKET, uintptr(domain), uintptr(typ), uintptr(proto), 0, 0, 0)
	if e != 0 {
		err = e
	}
	return
}
</code></pre>
<pre><code class="language-assembly">// func rawsocketcall(call int, a0, a1, a2, a3, a4, a5 uintptr) (n int, err int)
// Kernel interface gets call sub-number and pointer to a0.
// This method is found in the syscall/asm_linux_s390x.s file
TEXT ·rawsocketcall(SB),NOSPLIT,$0-72
	MOVD	$SYS_SOCKETCALL, R1	// syscall entry
	MOVD	call+0(FP), R2		// socket call number
	MOVD	$a0+8(FP), R3		// pointer to call arguments
	MOVD	$0, R4
	MOVD	$0, R5
	MOVD	$0, R6
	MOVD	$0, R7
	SYSCALL
	MOVD	$0xfffffffffffff001, R8
	CMPUBLT	R2, R8, oksock1
	MOVD	$-1, n+56(FP)
	NEG	R2, R2
	MOVD	R2, err+64(FP)
	RET
oksock1:
	MOVD	R2, n+56(FP)
	MOVD	$0, err+64(FP)
	RET
</code></pre>
<p>The <code>golang-socket-syscall.go</code> file in <em>Code Snippet 3</em> above showcases the <code>socket()</code>
method with a signature similar to that of the UNIX <code>socket()</code> API. What is even
more interesting is that the call to the <code>rawsocketcall()</code> in the <code>socket()</code> refers
to a function stub that is actually implemented in Assembly. I wrote an article
detailing the importance of Assembly in Go. The Assembly code appears to perform
the underlying syscall and passing in relevant arguments received from the Go
application, to the kernel.</p>
<p>The implementation of <code>bind()</code> is very similar. It also conforms to the <code>bind()</code> in
the Unix interface. It also makes a call to rawsocketcall with a _BIND
parameter. This is just an integer constant that refers to the integer 2, where
<code>_SOCKET</code> refers to 1. Other syscalls have their own unique constant integer
identifier.</p>
<h2><a class="header" href="#a-quick-note-on-file-descriptors" id="a-quick-note-on-file-descriptors">A Quick Note on File Descriptors</a></h2>
<p>The <code>socket()</code> syscall we saw in <em>Code Snippet 1</em> returns an integer, this integer
will be extremely important and will lay the foundation for several of the
following articles. The term File Descriptor should be memorized and not
forgotten as it will popup quite a bit when we begin creating, reading and
writing to connections. One thing you can ponder on for now, is why its called a
“File” descriptor. I answer this in the a future article.</p>
<p>For now, I think this is a good place to stop as we now have an understanding of sockets and some of the core syscalls that must be performed to create and bind addresses to them. In the next article we look at how socket connections work between client-server services.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
